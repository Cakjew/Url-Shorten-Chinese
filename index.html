<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="å¿«é€Ÿã€å®‰å…¨ã€å¯é çš„ç½‘å€ç¼©çŸ­æœåŠ¡">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://captcha.gurl.eu.org/cap.min.js"></script>
  <title>ç½‘å€ç¼©çŸ­å™¨ - å¿«é€Ÿå®‰å…¨</title>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'apple-blue': '#007AFF',
            'apple-blue-dark': '#0051D5',
            'apple-green': '#34C759',
            'apple-red': '#FF3B30',
            'apple-gray': '#86868b',
            'apple-gray-light': '#f5f5f7',
          },
          fontFamily: {
            'sf': ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', 'sans-serif'],
          },
          animation: {
            'float': 'float 20s ease-in-out infinite',
            'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
            'fade-in': 'fadeIn 0.3s ease',
            'shake': 'shake 0.5s ease',
            'scale-up': 'scaleUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translate(0, 0) rotate(0deg)' },
              '33%': { transform: 'translate(30px, -30px) rotate(120deg)' },
              '66%': { transform: 'translate(-20px, 20px) rotate(240deg)' },
            },
            slideUp: {
              'from': { opacity: '0', transform: 'translateY(40px)' },
              'to': { opacity: '1', transform: 'translateY(0)' },
            },
            fadeIn: {
              'from': { opacity: '0', transform: 'translateY(-10px)' },
              'to': { opacity: '1', transform: 'translateY(0)' },
            },
            shake: {
              '0%, 100%': { transform: 'translateX(0)' },
              '25%': { transform: 'translateX(-8px)' },
              '75%': { transform: 'translateX(8px)' },
            },
            scaleUp: {
              'from': { opacity: '0', transform: 'scale(0.9)' },
              'to': { opacity: '1', transform: 'scale(1)' },
            },
          },
        },
      },
    }
  </script>
  <style>
    @media (prefers-color-scheme: dark) {
      :root {
        color-scheme: dark;
      }
    }
    
    .glass {
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    
    .animate-spin-custom {
      animation: spin 0.6s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ç§»åŠ¨ç«¯è¾“å…¥æ¡†å’ŒæŒ‰é’®ä¼˜åŒ– */
    @media (max-width: 640px) {
      #submitBtn {
        min-height: 48px;
      }
      
      #urlInput {
        min-height: 48px;
        font-size: 16px; /* é˜²æ­¢ iOS è‡ªåŠ¨ç¼©æ”¾ */
      }
      
      /* ç¡®ä¿æŒ‰é’®æ–‡å­—ä¸æ¢è¡Œ */
      #submitBtn span {
        white-space: nowrap;
      }
      
      /* CAPTCHA widget ç¼©æ”¾ */
      cap-widget {
        transform: scale(0.9);
        transform-origin: center center;
      }
    }
    
    @media (max-width: 420px) {
      cap-widget {
        transform: scale(0.85);
      }
    }
  </style>
</head>
<body class="font-sf bg-apple-gray-light dark:bg-black text-gray-900 dark:text-gray-100 min-h-screen flex items-center justify-center p-5 relative overflow-x-hidden antialiased">
  
  <!-- åŠ¨ç”»èƒŒæ™¯çƒä½“ -->
  <div class="fixed top-[-250px] left-[-250px] w-[500px] h-[500px] rounded-full bg-apple-blue/15 blur-[80px] animate-float pointer-events-none"></div>
  <div class="fixed bottom-[-300px] right-[-300px] w-[600px] h-[600px] rounded-full bg-purple-500/10 blur-[80px] animate-float pointer-events-none" style="animation-delay: -10s;"></div>

  <!-- ä¸»å®¹å™¨ -->
  <div class="w-full max-w-2xl relative z-10">
    <!-- å¡ç‰‡ -->
    <div class="bg-white dark:bg-gray-900 glass rounded-2xl shadow-xl overflow-hidden animate-slide-up">
      
      <!-- å¤´éƒ¨ -->
      <header class="px-6 sm:px-8 py-8 sm:py-10 text-center border-b border-gray-200 dark:border-gray-800">
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold tracking-tight mb-2">ç¼©çŸ­æ‚¨çš„ç½‘å€</h1>
        <p class="text-apple-gray dark:text-gray-400 text-xs sm:text-sm md:text-base">å¿«é€Ÿã€å®‰å…¨ã€å¯é çš„ç½‘å€ç¼©çŸ­æœåŠ¡</p>
      </header>

      <!-- ä¸»ä½“ -->
      <div class="p-6 sm:p-8">
        <form id="shortenForm" onsubmit="handleSubmit(event)">
          <div class="mb-6">
            <label for="urlInput" class="block text-xs font-semibold text-apple-gray dark:text-gray-400 uppercase tracking-wider mb-3">
              è¾“å…¥è¦ç¼©çŸ­çš„ç½‘å€
            </label>
            <div class="flex flex-col gap-3">
              <input 
                type="text" 
                id="urlInput" 
                class="w-full h-12 sm:h-12 px-4 text-base bg-apple-gray-light dark:bg-black border-2 border-gray-300 dark:border-gray-700 rounded-lg transition-all duration-200 outline-none focus:border-apple-blue focus:ring-4 focus:ring-apple-blue/10 placeholder-gray-400 dark:placeholder-gray-600"
                placeholder="https://example.com/"
                autocomplete="off"
                spellcheck="false"
                aria-describedby="notice"
              >
              <button 
                type="submit" 
                id="submitBtn"
                class="w-full sm:w-auto sm:min-w-[120px] h-12 px-6 font-semibold text-white bg-apple-blue hover:bg-apple-blue-dark rounded-lg transition-all duration-200 hover:-translate-y-0.5 hover:shadow-lg active:translate-y-0 active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none whitespace-nowrap relative overflow-hidden"
              >
                ç¼©çŸ­
              </button>
            </div>
          </div>
          <div id="notice" role="alert" aria-live="polite"></div>
        </form>
      </div>

      <!-- é¡µè„š -->
      <footer class="px-6 sm:px-8 py-5 sm:py-6 text-center border-t border-gray-200 dark:border-gray-800">
        <a 
          href="https://github.com/Cakjew/Url-Shorten-Chinese" 
          target="_blank" 
          rel="noopener"
          class="inline-flex items-center gap-2 px-3 py-2 text-xs sm:text-sm font-medium text-apple-blue hover:bg-apple-blue/5 rounded-lg transition-all duration-200 group"
        >
          <span>æŸ¥çœ‹æºä»£ç </span>
          <span class="transition-transform duration-200 group-hover:translate-x-1">â†’</span>
        </a>
      </footer>
    </div>
  </div>

  <!-- éªŒè¯ç å¼¹çª— -->
  <div id="captchaModal" class="hidden fixed inset-0 z-50 items-center justify-center p-4 sm:p-5">
    <div class="absolute inset-0 bg-black/50 glass animate-fade-in" onclick="closeModal('captchaModal')"></div>
    <div class="relative w-full max-w-md bg-white dark:bg-gray-900 rounded-2xl shadow-2xl animate-scale-up">
      <div class="flex items-center justify-between px-5 sm:px-6 py-4 sm:py-5 border-b border-gray-200 dark:border-gray-800">
        <h2 class="text-base sm:text-lg font-semibold">éªŒè¯ç éªŒè¯</h2>
        <button 
          type="button" 
          onclick="closeModal('captchaModal')" 
          class="w-8 h-8 flex items-center justify-center text-2xl text-apple-gray hover:bg-apple-gray-light dark:hover:bg-gray-800 rounded-full transition-all duration-200"
          aria-label="å…³é—­"
        >
          Ã—
        </button>
      </div>
      <div class="p-5 sm:p-6">
        <p class="text-xs sm:text-sm text-apple-gray dark:text-gray-400 text-center mb-5">
          è¯·å®ŒæˆéªŒè¯ç ä»¥ç»§ç»­
        </p>
        <div class="flex justify-center">
          <cap-widget 
            id="capWidget" 
            data-cap-api-endpoint="https://captcha.gurl.eu.org/api/">
          </cap-widget>
        </div>
      </div>
    </div>
  </div>

  <!-- ç»“æœå¼¹çª— -->
  <div id="resultModal" class="hidden fixed inset-0 z-50 items-center justify-center p-4 sm:p-5">
    <div class="absolute inset-0 bg-black/50 glass animate-fade-in" onclick="closeModal('resultModal')"></div>
    <div class="relative w-full max-w-md bg-white dark:bg-gray-900 rounded-2xl shadow-2xl animate-scale-up">
      <div class="flex items-center justify-between px-5 sm:px-6 py-4 sm:py-5 border-b border-gray-200 dark:border-gray-800">
        <h2 class="text-base sm:text-lg font-semibold">çŸ­ç½‘å€å·²ç”Ÿæˆ</h2>
        <button 
          type="button" 
          onclick="closeModal('resultModal')" 
          class="w-8 h-8 flex items-center justify-center text-2xl text-apple-gray hover:bg-apple-gray-light dark:hover:bg-gray-800 rounded-full transition-all duration-200"
          aria-label="å…³é—­"
        >
          Ã—
        </button>
      </div>
      <div class="p-5 sm:p-6">
        <div id="resultUrl" class="text-center break-all text-apple-blue font-semibold text-sm sm:text-base"></div>
      </div>
      <div class="flex flex-col gap-3 px-5 sm:px-6 py-4 sm:py-5 border-t border-gray-200 dark:border-gray-800">
        <button 
          type="button" 
          onclick="copyToClipboard()"
          class="w-full h-12 px-6 font-semibold text-white bg-apple-blue hover:bg-apple-blue-dark rounded-lg transition-all duration-200 active:scale-[0.98]"
        >
          å¤åˆ¶é“¾æ¥
        </button>
        <button 
          type="button" 
          onclick="closeModal('resultModal')"
          class="w-full h-12 px-6 font-semibold text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 dark:hover:bg-gray-700 rounded-lg transition-all duration-200 active:scale-[0.98]"
        >
          å…³é—­
        </button>
      </div>
    </div>
  </div>

  <script>
    // çŠ¶æ€ç®¡ç†
    const state = {
      captchaToken: null,
      isProcessing: false,
      pendingUrl: null,
      generatedUrl: null
    };

    // å…ƒç´ 
    const elements = {
      form: document.getElementById('shortenForm'),
      input: document.getElementById('urlInput'),
      submitBtn: document.getElementById('submitBtn'),
      notice: document.getElementById('notice'),
      captchaModal: document.getElementById('captchaModal'),
      resultModal: document.getElementById('resultModal'),
      resultUrl: document.getElementById('resultUrl'),
      capWidget: document.getElementById('capWidget')
    };

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      // è®¾ç½®éªŒè¯ç ç›‘å¬å™¨
      if (elements.capWidget) {
        // éªŒè¯ç éªŒè¯æˆåŠŸ
        elements.capWidget.addEventListener('solve', (e) => {
          state.captchaToken = e.detail.token;
          console.log('âœ… éªŒè¯ç å·²éªŒè¯');
          closeModal('captchaModal');
          
          if (state.pendingUrl) {
            performShortening(state.pendingUrl);
            state.pendingUrl = null;
          }
        });

        // éªŒè¯ç é”™è¯¯
        elements.capWidget.addEventListener('error', (e) => {
          console.error('âŒ éªŒè¯ç é”™è¯¯:', e.detail);
          showNotice('éªŒè¯ç éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚', 'error');
        });

        // éªŒè¯ç é‡ç½®
        elements.capWidget.addEventListener('reset', () => {
          console.log('ğŸ”„ éªŒè¯ç å·²é‡ç½®');
          state.captchaToken = null;
        });

        // éªŒè¯ç è¿›åº¦ï¼ˆå¯é€‰ï¼šç”¨äºè°ƒè¯•ï¼‰
        elements.capWidget.addEventListener('progress', (e) => {
          console.log('â³ éªŒè¯ç è¿›åº¦:', e.detail);
        });
      }

      // è¾“å…¥éªŒè¯
      elements.input.addEventListener('input', () => {
        const value = elements.input.value.trim();
        if (value && !isValidUrl(value)) {
          elements.input.classList.add('border-apple-red');
          elements.input.classList.remove('border-gray-300', 'dark:border-gray-700');
        } else {
          elements.input.classList.remove('border-apple-red');
          elements.input.classList.add('border-gray-300', 'dark:border-gray-700');
        }
      });

      // é”®ç›˜å¿«æ·é”®
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal('captchaModal');
          closeModal('resultModal');
        }
      });
    });

    // URL éªŒè¯
    function isValidUrl(string) {
      try {
        const url = new URL(string);
        return url.protocol === 'http:' || url.protocol === 'https:';
      } catch {
        return false;
      }
    }

    // è¡¨å•æäº¤å¤„ç†
    function handleSubmit(event) {
      event.preventDefault();
      
      if (state.isProcessing) return;

      const url = elements.input.value.trim();

      if (!url) {
        showNotice('è¯·è¾“å…¥ç½‘å€', 'error');
        elements.input.focus();
        return;
      }

      if (!isValidUrl(url)) {
        showNotice('è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€ï¼ˆå¿…é¡»åŒ…å« http:// æˆ– https://ï¼‰', 'error');
        elements.input.classList.add('border-apple-red');
        elements.input.focus();
        return;
      }

      elements.input.classList.remove('border-apple-red');
      clearNotice();

      if (!state.captchaToken) {
        state.pendingUrl = url;
        openModal('captchaModal');
        return;
      }

      performShortening(url);
    }

    // æ‰§è¡Œç½‘å€ç¼©çŸ­
    async function performShortening(url) {
      if (state.isProcessing) return;

      state.isProcessing = true;
      setLoading(true);

      try {
        const response = await fetch(window.location.origin, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            url: url,
            captcha_token: state.captchaToken
          })
        });

        const data = await response.json();

        if (data.status === 200) {
          state.generatedUrl = window.location.origin + data.key;
          elements.resultUrl.textContent = state.generatedUrl;
          elements.input.value = '';
          
          // æˆåŠŸç”Ÿæˆåé‡ç½®éªŒè¯ç çŠ¶æ€
          resetCaptcha();
          
          showNotice('çŸ­ç½‘å€åˆ›å»ºæˆåŠŸï¼', 'success');
          setTimeout(() => {
            openModal('resultModal');
            clearNotice();
          }, 500);
        } else {
          const errorMsg = data.error || 'å‘ç”ŸæœªçŸ¥é”™è¯¯';
          showNotice(errorMsg, 'error');
          
          // å¦‚æœéªŒè¯å¤±è´¥ï¼Œé‡ç½®éªŒè¯ç 
          if (data.captcha_required || errorMsg.toLowerCase().includes('captcha')) {
            resetCaptcha();
          }
        }
      } catch (error) {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        showNotice(`ç½‘ç»œé”™è¯¯ï¼š${error.message}`, 'error');
        // ç½‘ç»œé”™è¯¯æ—¶é‡ç½®éªŒè¯ç 
        resetCaptcha();
      } finally {
        state.isProcessing = false;
        setLoading(false);
      }
    }

    // é‡ç½®éªŒè¯ç 
    function resetCaptcha() {
      state.captchaToken = null;
      
      // å¦‚æœå¯ç”¨ï¼Œè§¦å‘å°éƒ¨ä»¶çš„é‡ç½®äº‹ä»¶
      if (elements.capWidget && typeof elements.capWidget.reset === 'function') {
        try {
          elements.capWidget.reset();
          console.log('ğŸ”„ éªŒè¯ç å°éƒ¨ä»¶å·²é‡ç½®');
        } catch (error) {
          console.warn('é‡ç½®éªŒè¯ç å°éƒ¨ä»¶å¤±è´¥:', error);
        }
      }
    }

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    async function copyToClipboard() {
      if (!state.generatedUrl) return;

      const copyBtn = document.querySelector('#resultModal button.bg-apple-blue');
      const originalText = copyBtn.textContent;

      try {
        if (navigator.clipboard) {
          await navigator.clipboard.writeText(state.generatedUrl);
        } else {
          const textarea = document.createElement('textarea');
          textarea.value = state.generatedUrl;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
        }

        copyBtn.textContent = 'âœ“ å·²å¤åˆ¶';
        copyBtn.classList.remove('bg-apple-blue', 'hover:bg-apple-blue-dark');
        copyBtn.classList.add('bg-apple-green');

        setTimeout(() => {
          copyBtn.textContent = originalText;
          copyBtn.classList.remove('bg-apple-green');
          copyBtn.classList.add('bg-apple-blue', 'hover:bg-apple-blue-dark');
        }, 2000);
      } catch (error) {
        console.error('å¤åˆ¶å¤±è´¥:', error);
        showNotice('å¤åˆ¶å¤±è´¥', 'error');
      }
    }

    // å¼¹çª—ç®¡ç†
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = '';
        
        // å½“æœªå®ŒæˆéªŒè¯å°±å…³é—­éªŒè¯ç å¼¹çª—æ—¶ï¼Œé‡ç½®éªŒè¯ç 
        if (modalId === 'captchaModal' && !state.captchaToken) {
          state.pendingUrl = null;
          resetCaptcha();
        }
      }
    }

    // é€šçŸ¥ç®¡ç†
    function showNotice(message, type = 'error') {
      const bgColor = type === 'success' 
        ? 'bg-apple-green/10 text-apple-green' 
        : 'bg-apple-red/10 text-apple-red';
      const animation = type === 'error' ? 'animate-shake' : 'animate-fade-in';
      
      elements.notice.innerHTML = `
        <div class="px-4 py-3 rounded-lg text-sm font-medium mt-4 ${bgColor} ${animation}">
          ${message}
        </div>
      `;
    }

    function clearNotice() {
      elements.notice.innerHTML = '';
    }

    // åŠ è½½çŠ¶æ€
    function setLoading(loading) {
      elements.submitBtn.disabled = loading;
      if (loading) {
        elements.submitBtn.innerHTML = `
          <span>ç”Ÿæˆä¸­...</span>
          <span class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin-custom"></span>
        `;
      } else {
        elements.submitBtn.textContent = 'ç¼©çŸ­';
      }
    }
  </script>
</body>
</html>